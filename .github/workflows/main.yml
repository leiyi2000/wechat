name: Deploy

on:
  push:
    branches: 
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get the current branch SHA
      id: branch_sha # 后面的步骤可以用${{ steps.branch_sha.outputs.hash }}来引用这个值
      run: echo "::set-output name=hash::$(git rev-parse --short HEAD)"

    - name: Get the current date
      id: date # 后面的步骤可以用${{ steps.date.outputs.date }}来引用这个值
      run: echo "::set-output name=date::$(date +'%Y%m%d')"
    
    - name: Checkout Code
      uses: actions/checkout@v2
      with:
        path: code

    - name: Install Rsync
      run: sudo apt-get install -y rsync

    - name: Setup SSH 1
      run: mkdir -p ~/.ssh

    - name: Setup SSH 2
      run: ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Setup SSH 3
      run: echo ${{ secrets.SSH_PUB_KEY }} >> ~/.ssh/id_rsa.pub

    - name: Sync files
      run: |
        rsync -av --delete code/ root@${{ secrets.SERVER_HOST }}:/root/apps/wechat
